# Обнаружение переполнения стека

## Обзор

Bedrock RTOS реализует обнаружение переполнения стека с использованием механизма canary. Магическое значение (canary) размещается в начале стека каждой задачи и проверяется при переключении контекста.

## Детали реализации

### Значение Canary

Canary определяется как:
```c
#define BR_STACK_CANARY   0xDEADBEEF
```

### Принцип работы

1. **Инициализация**: При создании задачи (`br_task_create`) значение canary записывается в начало (наименьший адрес) стека задачи.

2. **Хранение**: Каждый TCB (`br_tcb_t`) содержит указатель на расположение canary:
   ```c
   uint32_t *stack_canary;   /* Указатель на canary в начале стека */
   ```

3. **Обнаружение**: Перед каждым переключением контекста (`br_sched_reschedule`) планировщик проверяет, не было ли повреждено значение canary, используя `br_hal_check_stack_overflow()`.

4. **Реакция**: Если обнаружено повреждение, система вызывает kernel panic и останавливает выполнение для предотвращения дальнейших повреждений.

### Код ошибки

Добавлен новый код ошибки:
```c
BR_ERR_STACK_OVF = -7  /* Обнаружено переполнение стека */
```

## Интерфейс HAL

### `br_hal_check_stack_overflow(br_tcb_t *tcb)`

Проверяет stack canary для указанной задачи. Если значение canary было повреждено (что указывает на переполнение стека), функция вызывает kernel panic.

**Параметры:**
- `tcb`: Указатель на блок управления задачей для проверки

**Поведение:**
- Сравнивает `*tcb->stack_canary` с `BR_STACK_CANARY`
- Если обнаружено несоответствие, вызывает `br_kernel_panic()` и останавливает систему

## Ограничения

- **Время обнаружения**: Переполнение стека обнаруживается только при переключении контекста. Если задача переполняет свой стек и никогда не отдает управление, переполнение не будет обнаружено до следующей попытки переключения.

- **Одно значение Canary**: Только одно значение canary в начале стека. Это обнаруживает полное переполнение, но может не поймать частичное повреждение.

- **Нет восстановления**: При обнаружении переполнения система останавливается. Это сделано намеренно для предотвращения неопределенного поведения.

## Будущие улучшения

Возможные улучшения:
- Множественные значения canary по всему стеку
- Периодическая проверка стека независимо от переключения контекста
- Watermarking использования стека для отладки
- Настраиваемая реакция на переполнение (паника vs. завершение задачи)

## Тестирование

Для тестирования обнаружения переполнения стека создайте задачу с маленьким стеком и вызовите рекурсивные вызовы или большие локальные массивы:

```c
static uint8_t test_stack[128];  /* Очень маленький стек */

void overflow_task(void *arg) {
    volatile uint8_t large_buffer[256];  /* Больше, чем стек! */
    /* Это вызовет переполнение и будет обнаружено при следующем переключении контекста */
}
```

## Ссылки

- `include/bedrock/br_types.h`: Константа canary и структура TCB
- `kernel/br_task.c`: Инициализация canary
- `kernel/br_sched.c`: Проверка canary при переключении контекста
- `arch/arm-cortex-m/br_hal_context.c`: Платформо-зависимая реализация
